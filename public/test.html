<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Math Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb; /* light gray background */
      color: #1a202c; /* dark gray text */
    }
    .container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
    }
    .card {
      background-color: #ffffff; /* white cards */
      border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
      padding: 2rem;
      margin-bottom: 1.5rem;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center min-h-screen p-4 sm:p-8">
  <div class="container mx-auto p-4 sm:p-8">
    <div class="card text-center">
      <h1 class="text-3xl sm:text-4xl font-bold text-teal-600 mb-2">Math Quiz</h1>
      <p class="text-gray-600 mb-6">Test your knowledge with these questions.</p>
    </div>

    <!-- The questions will be loaded here dynamically -->
    <div id="quiz-container" class="space-y-6">
      <p id="loading-message" class="text-center text-lg text-gray-500">Loading questions...</p>
    </div>
    <div id="error-message" class="hidden text-center text-red-500 mt-4"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const quizContainer = document.getElementById('quiz-container');
      const loadingMessage = document.getElementById('loading-message');
      const errorMessage = document.getElementById('error-message');

      let testId = null;
      const token = localStorage.getItem('token');

      if (!token) {
        loadingMessage.textContent = 'You are not logged in. Redirecting...';
        window.location.href = 'login.html';
        return;
      }

      async function fetchQuestions() {
        try {
          const response = await fetch('/api/test', {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          const data = await response.json();

          if (!response.ok) {
            loadingMessage.textContent = `Error: ${data.error || data.message}`;
            return;
          }

          testId = data.testId;
          renderQuestions(data.questions);
        } catch (error) {
          loadingMessage.textContent = 'Failed to load questions. Please check the server.';
          console.error('Error fetching questions:', error);
        }
      }

      function renderQuestions(questions) {
        loadingMessage.style.display = 'none';
        quizContainer.innerHTML = '';

        const form = document.createElement('form');
        form.id = 'quiz-form';
        form.addEventListener('submit', handleSubmit);

        questions.forEach((q, index) => {
          const questionCard = document.createElement('div');
          questionCard.className = 'card';
          questionCard.innerHTML = `
            <h3 class="text-lg sm:text-xl font-semibold mb-3">Q${index + 1}: ${q.question}</h3>
            <input
              type="text"
              name="answer-${q._id}"
              data-question-id="${q._id}"
              placeholder="Your answer"
              class="w-full px-4 py-2 rounded-lg bg-gray-100 text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-300"
              required
            />
          `;
          form.appendChild(questionCard);
        });

        const submitButton = document.createElement('button');
        submitButton.type = 'submit';
        submitButton.textContent = 'Submit Test';
        submitButton.className = 'w-full mt-6 py-3 px-6 rounded-lg font-bold text-white bg-teal-500 hover:bg-teal-600 transition-colors duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-teal-300 shadow-lg';
        form.appendChild(submitButton);

        quizContainer.appendChild(form);
      }

      async function handleSubmit(event) {
        event.preventDefault();

        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId');

        if (!token || !userId) {
          errorMessage.textContent = 'Session expired. Please log in again.';
          errorMessage.classList.remove('hidden');
          return;
        }

        const formData = new FormData(event.target);
        const answers = [];

        for (const [key, value] of formData.entries()) {
          const questionId = key.replace('answer-', '');
          answers.push({
            questionId: questionId,
            studentAnswer: value
          });
        }

        try {
          const response = await fetch(`/api/submit-test/${testId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ answers, userId })
          });

          const result = await response.json();
          if (!response.ok) {
            errorMessage.textContent = `Error: ${result.error || 'Failed to submit test.'}`;
            errorMessage.classList.remove('hidden');
            return;
          }

          const encodedResults = encodeURIComponent(JSON.stringify(result.results));
          window.location.href = `/test-result.html?results=${encodedResults}`;
        } catch (error) {
          errorMessage.textContent = 'Failed to submit test. Please try again.';
          errorMessage.classList.remove('hidden');
          console.error('Error submitting test:', error);
        }
      }

      fetchQuestions();
    });
  </script>
</body>
</html>
