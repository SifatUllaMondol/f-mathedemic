<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mathedemic | Practice</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #fdfdfd 0%, #f3f4f6 100%);
      transition: all 0.3s ease-in-out;
    }
    .navbar {
      background: rgba(222, 222, 222, 0.9);
      backdrop-filter: blur(10px);
    }
    .card {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 2px 4px 10px #4449;
    }
    .card:hover {
      transform: translateY(-6px) scale(1.01);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    .question-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Navbar with Profile -->
  <nav class="navbar fixed top-0 left-0 right-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <a href="/index.html">
          <img src="/img/mlogo.png" alt="Logo" class="h-20 w-auto" />
        </a>
        <div class="flex items-center space-x-3">
          <a href="/profile.html" class="group flex items-center space-x-2 bg-indigo-200 text-indigo-900 px-4 py-2 rounded-full hover:bg-indigo-300 transition-all duration-300">
            <svg class="w-6 h-6 text-indigo-700 group-hover:text-indigo-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span class="text-sm font-medium">Profile</span>
          </a>
          <button id="logoutButton" class="group flex items-center space-x-2 bg-rose-200 text-rose-900 px-4 py-2 rounded-full hover:bg-rose-300 transition-all duration-300">
            <svg class="w-6 h-6 text-rose-700 group-hover:text-rose-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
            </svg>
            <span class="text-sm font-medium">Logout</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="flex-grow flex items-center justify-center p-4 pt-20">
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-md p-8 md:p-12 space-y-8">
      <header class="text-center">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-800 bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400">Practice Questions</h1>
        <p class="mt-4 text-lg text-gray-600">Practice specific topics with AI-generated questions</p>
      </header>

      <!-- Tag Selection -->
      <div class="card p-6">
        <label for="tagSelect" class="block text-lg font-semibold text-gray-700 mb-3">Choose a topic to practice:</label>
        <div class="flex flex-col sm:flex-row gap-4">
          <select id="tagSelect" class="flex-1 px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <option value="">Select a topic...</option>
            <option value="ordinary">Ordinary Math</option>
            <option value="algebra">Algebra</option>
            <option value="geometry">Geometry</option>
            <option value="calculus">Calculus</option>
            <option value="javascript">JavaScript</option>
            <option value="python">Python</option>
            <option value="react">React</option>
          </select>
          
          <select id="countSelect" class="px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <option value="5">5 questions</option>
            <option value="10">10 questions</option>
            <option value="15">15 questions</option>
            <option value="20">20 questions</option>
          </select>
          
          <button id="generateBtn" class="px-6 py-3 bg-purple-500 text-white rounded-lg font-semibold hover:bg-purple-600 transition-colors duration-300">
            Generate Questions
          </button>
        </div>
      </div>

      <!-- Questions Container -->
      <div id="questions-container" class="space-y-4 hidden">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-700">Practice Questions</h2>
          <span id="source-badge" class="px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800"></span>
        </div>
        
        <div id="questions-list" class="space-y-4">
          <!-- Questions will be loaded here -->
        </div>
        
        <div class="flex gap-4 mt-6">
          <button id="checkAnswersBtn" class="flex-1 py-3 px-6 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition-colors duration-300">
            Check Answers
          </button>
          <button id="newPracticeBtn" class="flex-1 py-3 px-6 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition-colors duration-300">
            New Practice
          </button>
        </div>
      </div>

      <!-- Loading and Error States -->
      <div id="loading-message" class="hidden text-center py-8">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto"></div>
        <p class="mt-4 text-gray-600">Generating AI-powered questions...</p>
      </div>
      
      <div id="error-message" class="hidden text-center py-4 px-4 bg-red-100 text-red-700 rounded-lg"></div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'login.html';
      }

      // Logout functionality
      document.getElementById('logoutButton').addEventListener('click', function() {
        localStorage.removeItem('token');
        localStorage.removeItem('userId');
        window.location.href = 'login.html';
      });

      const tagSelect = document.getElementById('tagSelect');
      const countSelect = document.getElementById('countSelect');
      const generateBtn = document.getElementById('generateBtn');
      const questionsContainer = document.getElementById('questions-container');
      const questionsList = document.getElementById('questions-list');
      const loadingMessage = document.getElementById('loading-message');
      const errorMessage = document.getElementById('error-message');
      const sourceBadge = document.getElementById('source-badge');
      const checkAnswersBtn = document.getElementById('checkAnswersBtn');
      const newPracticeBtn = document.getElementById('newPracticeBtn');

      let currentQuestions = [];

      generateBtn.addEventListener('click', generateQuestions);
      checkAnswersBtn.addEventListener('click', checkAnswers);
      newPracticeBtn.addEventListener('click', resetPractice);

      async function generateQuestions() {
        const tag = tagSelect.value;
        const count = parseInt(countSelect.value);

        if (!tag) {
          showError('Please select a topic to practice');
          return;
        }

        showLoading();
        hideError();
        hideQuestions();

        try {
          const response = await fetch(`/api/practice/${tag}?count=${count}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'Failed to fetch questions');
          }

          currentQuestions = data.questions;
          displayQuestions(data.questions, data.source);
          
        } catch (error) {
          showError(error.message);
        } finally {
          hideLoading();
        }
      }

      function displayQuestions(questions, source) {
        questionsList.innerHTML = '';
        
        questions.forEach((question, index) => {
          const questionCard = document.createElement('div');
          questionCard.className = 'question-card';
          questionCard.innerHTML = `
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Q${index + 1}: ${question.question}</h3>
            <div class="space-y-2">
              <input
                type="text"
                id="answer-${question._id}"
                placeholder="Your answer..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
              <div id="feedback-${question._id}" class="hidden text-sm font-medium mt-2"></div>
            </div>
            <div class="mt-2 text-xs text-gray-500">
              Tags: ${question.tags.join(', ')}
            </div>
          `;
          questionsList.appendChild(questionCard);
        });

        // Update source badge
        sourceBadge.textContent = `Powered by ${source === 'ai' ? 'AI' : 'Database'}`;
        sourceBadge.className = `px-3 py-1 rounded-full text-sm font-medium ${
          source === 'ai' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'
        }`;

        questionsContainer.classList.remove('hidden');
      }

      function checkAnswers() {
        currentQuestions.forEach(question => {
          const answerInput = document.getElementById(`answer-${question._id}`);
          const feedbackDiv = document.getElementById(`feedback-${question._id}`);
          const userAnswer = answerInput.value.trim().toLowerCase();
          const correctAnswer = question.answer.toString().toLowerCase();

          if (userAnswer === correctAnswer) {
            feedbackDiv.textContent = '✅ Correct!';
            feedbackDiv.className = 'text-green-600 font-medium mt-2';
          } else {
            feedbackDiv.textContent = `❌ Incorrect. Correct answer: ${question.answer}`;
            feedbackDiv.className = 'text-red-600 font-medium mt-2';
          }
          feedbackDiv.classList.remove('hidden');
        });
      }

      function resetPractice() {
        questionsContainer.classList.add('hidden');
        currentQuestions = [];
        tagSelect.value = '';
        countSelect.value = '5';
      }

      function showLoading() {
        loadingMessage.classList.remove('hidden');
      }

      function hideLoading() {
        loadingMessage.classList.add('hidden');
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
      }

      function hideError() {
        errorMessage.classList.add('hidden');
      }

      function hideQuestions() {
        questionsContainer.classList.add('hidden');
      }
    });
  </script>
</body>
</html>